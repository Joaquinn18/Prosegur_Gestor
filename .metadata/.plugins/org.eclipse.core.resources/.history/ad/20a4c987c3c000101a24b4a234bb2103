package GUI;

import javax.swing.*;
import java.awt.*;
import Controlador.ControladorMotorizado;
import Controlador.MotorizadoNoEncontrado;
import Controlador.CartasInsuficientes;
import java.util.ArrayList;
import java.util.List;

public class Entrega extends JFrame {

    private static final long serialVersionUID = 1L;
    private JTextField txtDni;
    private JTextField txtCantidad;
    private JSpinner spinnerFecha;
    private JButton btnRegistrar, btnCancelar;
    private ControladorMotorizado controlador;

    public Entrega(ControladorMotorizado controlador, String prefillDni) {

        this.controlador = controlador;

        setTitle("Registrar Entrega");
        setSize(500, 330);  // 游댠 VENTANA M츼S GRANDE
        setLocationRelativeTo(null);
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        getContentPane().setLayout(null);

        // ------------------------------
        // DNI
        // ------------------------------
        JLabel lblDni = new JLabel("DNI:");
        lblDni.setFont(new Font("Arial", Font.BOLD, 14));
        lblDni.setBounds(30, 25, 150, 30);
        getContentPane().add(lblDni);

        txtDni = new JTextField(prefillDni != null ? prefillDni : "");
        txtDni.setEditable(false);
        txtDni.setBounds(180, 25, 260, 30);  // M치s grande
        getContentPane().add(txtDni);

        // ------------------------------
        // Cantidad
        // ------------------------------
        JLabel lblCantidad = new JLabel("Cantidad entregada:");
        lblCantidad.setFont(new Font("Arial", Font.BOLD, 14));
        lblCantidad.setBounds(30, 70, 200, 30);
        getContentPane().add(lblCantidad);

        txtCantidad = new JTextField();
        txtCantidad.setBounds(180, 70, 260, 30);
        getContentPane().add(txtCantidad);

        // ------------------------------
        // Fecha
        // ------------------------------
        JLabel lblFecha = new JLabel("Fecha (YYYY-MM-DD):");
        lblFecha.setFont(new Font("Arial", Font.BOLD, 14));
        lblFecha.setBounds(30, 115, 200, 30);
        getContentPane().add(lblFecha);

        SpinnerDateModel modelDate = new SpinnerDateModel(new java.util.Date(), null, null, java.util.Calendar.DAY_OF_MONTH);
        spinnerFecha = new JSpinner(modelDate);
        JSpinner.DateEditor editor = new JSpinner.DateEditor(spinnerFecha, "yyyy-MM-dd");
        spinnerFecha.setEditor(editor);
        spinnerFecha.setBounds(180, 115, 260, 30);
        getContentPane().add(spinnerFecha);

        // ------------------------------
        // Bot칩n Registrar
        // ------------------------------
        btnRegistrar = new JButton("Registrar");
        btnRegistrar.setBounds(120, 200, 120, 35); // M치s grande
        getContentPane().add(btnRegistrar);

        // ------------------------------
        // Bot칩n Cancelar
        // ------------------------------
        btnCancelar = new JButton("Cancelar");
        btnCancelar.setBounds(260, 200, 120, 35);
        getContentPane().add(btnCancelar);

        btnCancelar.addActionListener(e -> dispose());

        // ------------------------------
        // Acci칩n Registrar
        // ------------------------------
        btnRegistrar.addActionListener(e -> {

            String dni = txtDni.getText().trim();
            String cantidadStr = txtCantidad.getText().trim();

            java.util.Date fechaUtil = (java.util.Date) spinnerFecha.getValue();
            java.text.SimpleDateFormat sdf = new java.text.SimpleDateFormat("yyyy-MM-dd");
            String fechaStr = sdf.format(fechaUtil);

            int requestedCantidad;

            try {
                requestedCantidad = Integer.parseInt(cantidadStr);
                if (requestedCantidad <= 0) {
                    JOptionPane.showMessageDialog(this, "Cantidad debe ser mayor que 0.");
                    return;
                }
            } catch (NumberFormatException ex) {
                JOptionPane.showMessageDialog(this, "Cantidad inv치lida. Debe ser un n칰mero entero.");
                return;
            }

            // ---------------------------------------------
            // Ingresar detalles de cada tarjeta
            // ---------------------------------------------
            List<Modelado.DetalleEntrega> detalles = new ArrayList<>();

            for (int i = 1; i <= requestedCantidad; i++) {

                JTextField txtCliente = new JTextField();
                JTextField txtBanco = new JTextField();
                JTextField txtDireccion = new JTextField();
                JCheckBox chkConforme = new JCheckBox("Conforme");

                JPanel panelForm = new JPanel(new GridLayout(0, 1));
                panelForm.add(new JLabel("Tarjeta #" + i));
                panelForm.add(new JLabel("Nombre cliente:"));
                panelForm.add(txtCliente);
                panelForm.add(new JLabel("Banco:"));
                panelForm.add(txtBanco);
                panelForm.add(new JLabel("Direcci칩n:"));
                panelForm.add(txtDireccion);
                panelForm.add(chkConforme);

                int option = JOptionPane.showConfirmDialog(
                        this, panelForm,
                        "Detalles tarjeta " + i,
                        JOptionPane.OK_CANCEL_OPTION,
                        JOptionPane.PLAIN_MESSAGE
                );

                if (option != JOptionPane.OK_OPTION) {

                    int c = JOptionPane.showConfirmDialog(
                            this,
                            "쮺ancelar registro de todas las tarjetas?",
                            "Confirmar",
                            JOptionPane.YES_NO_OPTION
                    );

                    if (c == JOptionPane.YES_OPTION) return;

                    i--;
                    continue;
                }

                // Validaciones
                String cliente = txtCliente.getText().trim();
                String banco = txtBanco.getText().trim();
                String direccion = txtDireccion.getText().trim();
                boolean conforme = chkConforme.isSelected();

                if (cliente.isEmpty()) {
                    int resp = JOptionPane.showConfirmDialog(
                            this,
                            "Cliente vac칤o. 쮻esea volver a ingresar este detalle?",
                            "Campo vac칤o",
                            JOptionPane.YES_NO_OPTION
                    );

                    if (resp == JOptionPane.YES_OPTION) {
                        i--;
                        continue;
                    }
                }

                detalles.add(new Modelado.DetalleEntrega(cliente, banco, direccion, conforme));
            }

            try {
                controlador.registrarEntrega(dni, requestedCantidad, fechaStr, detalles);

                JOptionPane.showMessageDialog(this,
                        "Entrega registrada correctamente (solo se contaron las conformes).");

                dispose();

            } catch (MotorizadoNoEncontrado ex) {
                JOptionPane.showMessageDialog(this, ex.getMessage());
            } catch (CartasInsuficientes ex) {
                JOptionPane.showMessageDialog(this, ex.getMessage());
            } catch (IllegalArgumentException ex) {
                JOptionPane.showMessageDialog(this, "No se registr칩: " + ex.getMessage());
            } catch (Exception ex) {
                ex.printStackTrace();
                JOptionPane.showMessageDialog(this, "Error inesperado: " + ex.getMessage());
            }
        });
    }
}
