package GUI;

import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;

import Controlador.ControladorMotorizado;
import Modelado.Motorizado;
import repositorio.FileManager;
import repositorio.InMemoryDatabase;

public class MainMenu extends JFrame {

    private static final long serialVersionUID = 1L;

    private static final Color PROSEGUR_YELLOW = new Color(255, 209, 0);
    private static final Color PROSEGUR_BLACK = new Color(18, 18, 18);
    private static final Font TITLE_FONT = new Font("Montserrat", Font.BOLD, 22);
    private static final Font SUBTITLE_FONT = new Font("Montserrat", Font.PLAIN, 14);

    private ControladorMotorizado controlador;

    private JButton btnRegistroMotorizado;
    private JButton btnListadoMotorizado;
    private JButton btnRegistrarEntregas;
    private JButton btnReporteEntregas;
    private JButton btnHistorialEntregas;
    private JButton btnExportar;
    private JButton btnImportar;
    private JButton btnBackup;

    public MainMenu() {

        controlador = new ControladorMotorizado();

        // -------- CONFIG VENTANA ---------
        setTitle("Panel Operativo - Prosegur");
        setSize(600, 700);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setResizable(false);

        JPanel contentPanel = new JPanel(new BorderLayout());
        contentPanel.setBackground(PROSEGUR_BLACK);
        setContentPane(contentPanel);

        // -------- HEADER ---------
        JPanel headerPanel = new JPanel(new BorderLayout());
        headerPanel.setBackground(PROSEGUR_YELLOW);
        headerPanel.setBorder(BorderFactory.createEmptyBorder(25, 30, 20, 30));

        JLabel lblTitulo = new JLabel("⚫ Panel Operativo Prosegur", SwingConstants.LEFT);
        lblTitulo.setFont(TITLE_FONT);
        lblTitulo.setForeground(PROSEGUR_BLACK);

        JLabel lblSubtitulo = new JLabel("Control total de motorizados y entregas", SwingConstants.LEFT);
        lblSubtitulo.setFont(SUBTITLE_FONT);
        lblSubtitulo.setForeground(PROSEGUR_BLACK);

        headerPanel.add(lblTitulo, BorderLayout.NORTH);
        headerPanel.add(lblSubtitulo, BorderLayout.SOUTH);

        contentPanel.add(headerPanel, BorderLayout.NORTH);
        JPanel footerPanel = new JPanel(new BorderLayout());
        footerPanel.setBackground(PROSEGUR_BLACK);
        footerPanel.setBorder(BorderFactory.createEmptyBorder(15, 15, 20, 15));

        // -------- CENTER / GRIDBAG ---------
        JPanel centerPanel = new JPanel(new GridBagLayout());
        centerPanel.setOpaque(false);
        centerPanel.setBorder(BorderFactory.createEmptyBorder(30, 80, 30, 80));

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.gridx = 0;
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.insets = new Insets(10, 0, 10, 0);
        gbc.weightx = 1.0;

        // -------- BOTONES ---------

        btnRegistroMotorizado = createMenuButton("⚫ Registrar Motorizado");
        centerPanel.add(btnRegistroMotorizado, gbc);

        gbc.gridy = 1;
        btnListadoMotorizado = createMenuButton("⚫ Listado de Motorizados");
        centerPanel.add(btnListadoMotorizado, gbc);

        gbc.gridy = 2;
        btnRegistrarEntregas = createMenuButton("⚫ Registrar Entregas");
        centerPanel.add(btnRegistrarEntregas, gbc);

        gbc.gridy = 3;
        btnReporteEntregas = createMenuButton("⚫ Reporte de Entregas");
        centerPanel.add(btnReporteEntregas, gbc);

        gbc.gridy = 4;
        btnHistorialEntregas = createMenuButton("⚫ Historial de Entregas");
        centerPanel.add(btnHistorialEntregas, gbc);

        gbc.gridy = 5;
        btnExportar = createSecondaryButton("Exportar CSV ⚫");
        centerPanel.add(btnExportar, gbc);

        gbc.gridy = 6;
        btnImportar = createSecondaryButton("Importar CSV ⚫");
        centerPanel.add(btnImportar, gbc);

        gbc.gridy = 7;
        btnBackup = createSecondaryButton("Backup ⚫");
        centerPanel.add(btnBackup, gbc);

        contentPanel.add(centerPanel, BorderLayout.CENTER);

        // -------- FOOTER ---------
        JLabel footer = new JLabel("⚫ Mantén tus datos seguros con Prosegur", SwingConstants.CENTER);
        footer.setForeground(PROSEGUR_YELLOW);
        footer.setFont(new Font("Montserrat", Font.PLAIN, 12));
        footerPanel.add(footer, BorderLayout.CENTER);
        JButton btnAutores = new JButton("Autores");
        btnAutores.setFont(new Font("Montserrat", Font.BOLD, 12));
        btnAutores.setForeground(PROSEGUR_BLACK);
        btnAutores.setBackground(PROSEGUR_YELLOW);
        btnAutores.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
        btnAutores.setFocusPainted(false);
        btnAutores.setBorder(BorderFactory.createEmptyBorder(8, 14, 8, 14));
        footerPanel.add(btnAutores, BorderLayout.WEST);

        contentPanel.add(footerPanel, BorderLayout.SOUTH);
        // -------- LISTENERS ---------
        btnRegistroMotorizado.addActionListener(e -> new RegistroMotorizadoFrame(controlador).setVisible(true));

        btnListadoMotorizado.addActionListener(e -> new ListadoMotorizadoFrame(controlador).setVisible(true));

        btnRegistrarEntregas.addActionListener(e -> registrarEntregaDialog());

        btnReporteEntregas.addActionListener(e -> new ReporteEntregasFrame(controlador).setVisible(true));

        btnHistorialEntregas.addActionListener(e -> new HistorialEntregaFrame(controlador).setVisible(true));

        btnExportar.addActionListener(e -> exportarCSV());

        btnImportar.addActionListener(e -> importarCSV());

        btnBackup.addActionListener(e -> backupArchivos());
        btnAutores.addActionListener(e -> new Autoresgui().setVisible(true));
    }

    // --------- MÉTODOS AUXILIARES ---------

    private void registrarEntregaDialog() {
        String dniSeleccionado = JOptionPane.showInputDialog(this, "Ingrese DNI del motorizado:");
        if (dniSeleccionado == null) return;
        dniSeleccionado = dniSeleccionado.trim();

        if (!dniSeleccionado.matches("\\d{8}")) {
            JOptionPane.showMessageDialog(this, "El DNI debe contener exactamente 8 dígitos.");
            return;
        }

        if (!controlador.existeDni(dniSeleccionado)) {
            JOptionPane.showMessageDialog(this, "No existe motorizado con ese DNI.");
            return;
        }

        Entrega ef = new Entrega(controlador, dniSeleccionado);
        ef.setVisible(true);
    }

    private void exportarCSV() {
        try {
            Path pMot = Paths.get("data", "motorizados.csv");
            FileManager.exportarMotorizadosCSV(InMemoryDatabase.getMotorizados(), pMot);

            Path pEnt = Paths.get("data", "entregas.csv");
            FileManager.exportarEntregasCSV(InMemoryDatabase.getEntregas(), pEnt);

            JOptionPane.showMessageDialog(this, "Exportado a /data correctamente.");
        } catch (Exception ex) {
            JOptionPane.showMessageDialog(this, "Error al exportar: " + ex.getMessage());
        }
    }

    private void importarCSV() {
        JFileChooser chooser = new JFileChooser("data");
        chooser.setDialogTitle("Seleccione CSV de motorizados para importar");

        if (chooser.showOpenDialog(this) == JFileChooser.APPROVE_OPTION) {
            try {
                Path sel = chooser.getSelectedFile().toPath();
                List<Motorizado> importados = FileManager.importarMotorizadosCSV(sel);

                int agregados = 0;
                int omitidos = 0;
                for (Motorizado m : importados) {
                    if (!InMemoryDatabase.existeDni(m.getDni())) {
                        InMemoryDatabase.addMotorizado(m);
                        agregados++;
                    } else {
                        omitidos++;
                    }
                }

                JOptionPane.showMessageDialog(this,
                        "Importación completada.\nAgregados: " + agregados + "\nOmitidos: " + omitidos);

            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "Error al importar: " + ex.getMessage());
            }
        }
    }

    private void backupArchivos() {
        try {
            Path src = Paths.get("data", "motorizados.csv");
            Path dest = Paths.get("data", "backup", "motorizados_backup_" + System.currentTimeMillis() + ".csv");
            FileManager.backupFile(src, dest);

            JOptionPane.showMessageDialog(this, "Backup creado:\n" + dest.toString());
        } catch (Exception ex) {
            JOptionPane.showMessageDialog(this, "Error al crear backup: " + ex.getMessage());
        }
    }

    // --------- BOTONES ESTILIZADOS ---------

    private JButton createMenuButton(String text) {
        JButton button = new JButton(text);
        button.setFont(new Font("Montserrat", Font.BOLD, 16));
        button.setForeground(PROSEGUR_BLACK);
        button.setBackground(PROSEGUR_YELLOW);
        button.setFocusPainted(false);
        button.setBorder(BorderFactory.createEmptyBorder(14, 18, 14, 18));
        button.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
        button.setOpaque(true);
        return button;
    }

    private JButton createSecondaryButton(String text) {
        JButton button = new JButton(text);
        button.setFont(new Font("Montserrat", Font.BOLD, 14));
        button.setForeground(PROSEGUR_YELLOW);
        button.setBackground(PROSEGUR_BLACK);
        button.setBorder(BorderFactory.createLineBorder(PROSEGUR_YELLOW, 2, true));
        button.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
        button.setFocusPainted(false);
        button.setOpaque(true);
        return button;
    }
}
