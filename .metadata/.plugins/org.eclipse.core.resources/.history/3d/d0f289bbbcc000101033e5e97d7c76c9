package Controlador;
import repositorio.InMemoryDatabase;
import Modelado.Motorizado;
import javax.swing.JOptionPane;
import java.util.List;
import java.util.ArrayList;
import Modelado.ReporteEntrega;
import Modelado.Motorizado;
import repositorio.InMemoryDatabase;
import Modelado.Entrega;
import Modelado.DetalleEntrega;
import Controlador.CartasInsuficientes;
import Controlador.MotorizadoNoEncontrado;
import Modelado.HistorialEntrega;

public class ControladorMotorizado {
	
	
	
	public void guardarMotorizado(Motorizado m) {
		 InMemoryDatabase.addMotorizado(m);
        JOptionPane.showMessageDialog(null,
                "Motorizado guardado:\n" +
                "DNI: " + m.getDni() + "\n" +
                "Nombres: " + m.getNombres() + "\n" +
                "Apellidos: " + m.getApellidos() + "\n" +
                "Celular: " + m.getCelular() + "\n" +
                "Placa: " + m.getPlaca()
        );
    }
	  public List<Motorizado> listarMotorizados() {
	        return InMemoryDatabase.getMotorizados();
	    }
	  public boolean eliminarPorDni(String dni) {
		    if (dni == null || dni.trim().isEmpty()) return false;
		    return InMemoryDatabase.EliminarPorDni(dni.trim());
		}
	  public boolean existeDni(String dni) {
		    return InMemoryDatabase.existeDni(dni);
		}
	  public boolean EditarporDNI(String dni, String nuevosNombres, String nuevosApellidos,
              String nuevoCelular, int nuevasTarjetas, String nuevoEstado) 
	  {
		  if (dni == null || dni.trim().isEmpty()) return false;
		  return repositorio.InMemoryDatabase.Editar(dni.trim(), nuevosNombres, nuevosApellidos,
                                  nuevoCelular, nuevasTarjetas, nuevoEstado);
	  }
	
	  public void registrarEntrega(Modelado.Motorizado m, int cantidad) 
	          throws MotorizadoNoEncontrado, CartasInsuficientes {
	      if (m == null) throw new MotorizadoNoEncontrado("Motorizado nulo.");
	      registrarEntrega(m.getDni(), cantidad); 
	  }
		  
	  public void registrarEntrega(String dni, int cantidad) 
	          throws MotorizadoNoEncontrado, CartasInsuficientes {
	     
	      java.text.SimpleDateFormat sdf = new java.text.SimpleDateFormat("yyyy-MM-dd");
	      String hoy = sdf.format(new java.util.Date());
	      registrarEntrega(dni, cantidad, hoy); 
	  }


	 
	  public void registrarEntrega(int id, int cantidad, String fecha) 
	          throws MotorizadoNoEncontrado, CartasInsuficientes {
	      Modelado.Motorizado m = InMemoryDatabase.findById(id);
	      if (m == null) throw new MotorizadoNoEncontrado("No existe motorizado con id: " + id);
	  
	      registrarEntrega(m.getDni(), cantidad, fecha);
	  }
	  

	 public void registrarEntrega(String dni, int cantidad, String fecha) 
	          throws MotorizadoNoEncontrado, CartasInsuficientes {
	      if (dni == null || dni.trim().isEmpty()) throw new MotorizadoNoEncontrado("DNI inválido.");
	      Modelado.Motorizado m = InMemoryDatabase.findByDniObj(dni.trim());
	      if (m == null) throw new MotorizadoNoEncontrado("No existe motorizado con DNI: " + dni);

	      
	      

	      if (cantidad <= 0) throw new IllegalArgumentException("La cantidad debe ser mayor que 0.");

	      
	      int disponibles = m.getTarjetasAsignadas();
	      if (cantidad > disponibles) {
	         
	          throw new CartasInsuficientes("No hay suficientes tarjetas. Disponibles: " 
	                                               + disponibles + ", solicitado: " + cantidad);
	      }

	      
	      Modelado.Entrega e = new Modelado.Entrega(0, dni.trim(), cantidad, fecha);
	      boolean added = InMemoryDatabase.addEntrega(e);
	      if (!added) {
	          throw new RuntimeException("No se pudo registrar la entrega (error interno).");
	      }

	      
	      m.setTarjetasAsignadas(disponibles - cantidad);
	      
	    
	  }
	 
	 public List<ReporteEntrega> generarReporteEntregas() {
		    List<ReporteEntrega> reporte = new ArrayList<>();
		    List<Motorizado> lista = InMemoryDatabase.getMotorizados(); // copia de motorizados

		    for (Motorizado m : lista) {
		        String dni = m.getDni();
		        int entregado = InMemoryDatabase.getTotalEntregadoPorDni(dni); // suma en ENTREGAS
		        int restante = m.getTarjetasAsignadas(); // campo actualizado al registrar entregas
		        int inicial = entregado + restante; // reconstruimos el total inicial asignado
		        double porcentaje = (inicial == 0) ? 0.0 : (entregado * 100.0 / inicial);

		        ReporteEntrega r = new ReporteEntrega(
		                dni,
		                (m.getNombres() == null ? "" : m.getNombres() + " " + (m.getApellidos() == null ? "" : m.getApellidos())),
		                inicial,
		                entregado,
		                restante,
		                porcentaje
		        );
		        reporte.add(r);
		    }
		    return reporte;

}
	 public void registrarEntrega(String dni, int requestedCantidad, String fecha, List<DetalleEntrega> detalles)
		        throws MotorizadoNoEncontrado, CartasInsuficientes {
		    if (dni == null || dni.trim().isEmpty()) throw new MotorizadoNoEncontrado("DNI inválido.");
		    Modelado.Motorizado m = InMemoryDatabase.findByDniObj(dni.trim());
		    if (m == null) throw new MotorizadoNoEncontrado("No existe motorizado con DNI: " + dni);

		    if (requestedCantidad <= 0) throw new IllegalArgumentException("La cantidad debe ser mayor que 0.");

		    // calcular cuántos detalles están 'conforme'
		    int aceptadas = 0;
		    if (detalles != null) {
		        for (DetalleEntrega d : detalles) {
		            if (d != null && d.isConforme()) aceptadas++;
		        }
		    }

		    if (aceptadas <= 0) {
		        // No hay entregas válidas; lanzamos excepción o simplemente no registramos.
		        throw new IllegalArgumentException("No hay entregas conformes para registrar.");
		    }

		    int disponibles = m.getTarjetasAsignadas();
		    if (aceptadas > disponibles) {
		        // si se intentan aceptar más de las tarjetas disponibles -> excepción personalizada
		        throw new CartasInsuficientes("No hay suficientes tarjetas. Disponibles: " 
		                                             + disponibles + ", conformes: " + aceptadas);
		    }

		    // crear Entrega con cantidad = aceptadas, requestedCantidad = requestedCantidad, y detalles
		    Entrega e = new Entrega(0, dni.trim(), aceptadas, requestedCantidad, fecha, detalles);
		    boolean added = InMemoryDatabase.addEntrega(e);
		    if (!added) {
		        throw new RuntimeException("No se pudo registrar la entrega (error interno).");
		    }

		    // actualizar motorizado: restar solo las aceptadas
		    m.setTarjetasAsignadas(disponibles - aceptadas);
		} 
	 public List<HistorialEntrega> obtenerHistorialEntregas() {
         List<HistorialEntrega> historial = new ArrayList<>();
         List<Entrega> entregas = InMemoryDatabase.getEntregas();

         for (Entrega entrega : entregas) {
             if (entrega == null) continue;

             Motorizado motorizado = InMemoryDatabase.findByDniObj(entrega.getDniMotorizado());
             String nombres = "";
             String apellidos = "";
             if (motorizado != null) {
                 nombres = motorizado.getNombres() == null ? "" : motorizado.getNombres().trim();
                 apellidos = motorizado.getApellidos() == null ? "" : motorizado.getApellidos().trim();
             }

             String nombreCompleto = (nombres + " " + apellidos).trim();

             if (entrega.getDetalles() != null && !entrega.getDetalles().isEmpty()) {
                 for (DetalleEntrega detalle : entrega.getDetalles()) {
                     if (detalle == null) continue;
                     historial.add(new HistorialEntrega(
                             entrega.getFecha(),
                             detalle.getCliente(),
                             detalle.getDireccion(),
                             detalle.getBanco(),
                             nombreCompleto,
                             entrega.getDniMotorizado(),
                             detalle.isConforme()
                     ));
                 }
             } else {
                 historial.add(new HistorialEntrega(
                         entrega.getFecha(),
                         "",
                         "",
                         "",
                         nombreCompleto,
                         entrega.getDniMotorizado(),
                         false
                 ));
             }
         }

         return historial;
     }
}

