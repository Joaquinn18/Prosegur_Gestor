package GUI;
import javax.swing.*;
import java.awt.*;
import GUI.Entrega;
import Controlador.ControladorMotorizado;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;
import javax.swing.JFileChooser;
import repositorio.FileManager;
import repositorio.InMemoryDatabase;
import Modelado.Motorizado;
import Controlador.ControladorMotorizado;



public class MainMenu extends JFrame implements ActionListener {
	private static final long serialVersionUID = 1L;
	private JButton btnRegistroMotorizado;
    private ControladorMotorizado controlador;
    private JButton btnRegistrarEntregas;
    private JButton btnReporteEntregas;
    private JButton btnExportar;
    private JButton btnImportar;
    private JButton btnBackup;
    
    public MainMenu() {
        controlador = new ControladorMotorizado();

        setTitle("Menú Principal - Sistema");
        setSize(393, 273);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setLocationRelativeTo(null);

        JPanel panel = new JPanel();
        panel.setLayout(null);

        btnRegistroMotorizado = new JButton("Registrar Motorizado");
        btnRegistroMotorizado.setBounds(85, 29, 201, 25);
        panel.add(btnRegistroMotorizado);

        getContentPane().add(panel);
        
        JButton btnListadoMotorizados = new JButton("Listado de Motorizados");
        btnListadoMotorizados.setBounds(85, 65, 201, 25);
        panel.add(btnListadoMotorizados);
        
        btnRegistrarEntregas = new JButton("Registrar Entregas");
        btnRegistrarEntregas.addActionListener(this);
        btnRegistrarEntregas.setBounds(87, 101, 199, 25);
        panel.add(btnRegistrarEntregas);

        btnReporteEntregas = new JButton("Reporte Entregas");
        btnReporteEntregas.setBounds(85, 137, 201, 25); // ajusta Y si tienes otros botones
        panel.add(btnReporteEntregas);

        btnExportar = new JButton("Exportar CSV");
        btnExportar.setBounds(73, 154, 143, 25);
        panel.add(btnExportar);

        btnImportar = new JButton("Importar CSV");
        btnImportar.setBounds(73, 184, 143, 25);
        panel.add(btnImportar);

        btnBackup = new JButton("Backup");
        btnBackup.setBounds(73, 214, 143, 25);
        panel.add(btnBackup);
        
        
        btnReporteEntregas.addActionListener(e -> {
            ReporteEntregasFrame reporte = new ReporteEntregasFrame(controlador != null ? controlador : new ControladorMotorizado());
            reporte.setVisible(true);
        });
        
        btnListadoMotorizados.addActionListener(e -> {
            ListadoMotorizadoFrame listadoFrame = new ListadoMotorizadoFrame(controlador);
            listadoFrame.setVisible(true);
        });
       
        btnRegistroMotorizado.addActionListener(e -> {
            RegistroMotorizadoFrame registroFrame = new RegistroMotorizadoFrame(controlador);
            registroFrame.setVisible(true);
        });
    }
	public void actionPerformed(ActionEvent e) {
		if (e.getSource() == btnRegistrarEntregas) {
			do_btnRegistrarEntregas_actionPerformed(e);
		}
	}
	
	btnExportar.addActionListener(ev -> {
	    try {
	        Path pMot = Paths.get("data", "motorizados.csv");
	        FileManager.exportarMotorizadosCSV(InMemoryDatabase.getMotorizados(), pMot);

	        Path pEnt = Paths.get("data", "entregas.csv");
	        FileManager.exportarEntregasCSV(InMemoryDatabase.getEntregas(), pEnt);

	        JOptionPane.showMessageDialog(this, "Exportado motorizados y entregas a carpeta data/");
	    } catch (Exception ex) {
	        ex.printStackTrace();
	        JOptionPane.showMessageDialog(this, "Error al exportar: " + ex.getMessage());
	    }
	});

	btnImportar.addActionListener(ev -> {
	    JFileChooser chooser = new JFileChooser("data");
	    chooser.setDialogTitle("Selecciona CSV de motorizados para importar");
	    int res = chooser.showOpenDialog(this);
	    if (res == JFileChooser.APPROVE_OPTION) {
	        try {
	            Path sel = chooser.getSelectedFile().toPath();
	            List<Motorizado> importados = FileManager.importarMotorizadosCSV(sel);
	            int agregados = 0;
	            int omitidos = 0;
	            for (Motorizado m : importados) {
	                if (!InMemoryDatabase.existeDni(m.getDni())) {
	                    InMemoryDatabase.addMotorizado(m);
	                    agregados++;
	                } else {
	                    omitidos++;
	                }
	            }
	            JOptionPane.showMessageDialog(this, "Importación finalizada. Agregados: " + agregados + " | Omitidos (duplicados): " + omitidos);
	        } catch (Exception ex) {
	            ex.printStackTrace();
	            JOptionPane.showMessageDialog(this, "Error al importar: " + ex.getMessage());
	        }
	    }
	});

	btnBackup.addActionListener(ev -> {
	    try {
	        // ejemplo de backup simple: copia el motorizados.csv a backups con fecha
	        Path src = Paths.get("data", "motorizados.csv");
	        Path dest = Paths.get("data", "backup", "motorizados_backup_" + System.currentTimeMillis() + ".csv");
	        FileManager.backupFile(src, dest);
	        JOptionPane.showMessageDialog(this, "Backup creado: " + dest.toString());
	    } catch (Exception ex) {
	        ex.printStackTrace();
	        JOptionPane.showMessageDialog(this, "Error al crear backup: " + ex.getMessage());
	    }
	});
	
	
	protected void do_btnRegistrarEntregas_actionPerformed(ActionEvent e) {
		
	    String dniSeleccionado = JOptionPane.showInputDialog(this, "Ingrese DNI del motorizado para registrar entrega:");
	    if (dniSeleccionado == null) return; // usuario canceló
	    dniSeleccionado = dniSeleccionado.trim();

	    
	    if (!dniSeleccionado.matches("\\d{8}")) {
	        JOptionPane.showMessageDialog(this, "DNI inválido: debe contener exactamente 8 dígitos.");
	        return;
	    }

	   
	    Entrega ef = new Entrega(this.controlador != null ? this.controlador : new ControladorMotorizado(), dniSeleccionado);
	    ef.setVisible(true);

	 
	    ef.addWindowListener(new java.awt.event.WindowAdapter() {
	        @Override
	        public void windowClosed(java.awt.event.WindowEvent e) {
	
	        }
	    });
		
		
	}
	
	
}
}
