package GUI;

import Controlador.ControladorMotorizado;
import Modelado.HistorialEntrega;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.util.ArrayList;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Set;

public class HistorialEntregasFrame extends JFrame {
    private static final long serialVersionUID = 1L;

    private final ControladorMotorizado controlador;
    private final JTable tablaHistorial;
    private final DefaultTableModel modeloTabla;
    private final JComboBox<String> comboMensajero;
    private final JComboBox<String> comboBanco;
    private final List<HistorialEntrega> historialCompleto;

    public HistorialEntregasFrame(ControladorMotorizado controlador) {
        this.controlador = controlador != null ? controlador : new ControladorMotorizado();
        this.historialCompleto = new ArrayList<>();
        recargarHistorial();

        setTitle("Historial de Entregas");
        setSize(780, 480);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(DISPOSE_ON_CLOSE);

        JPanel contentPane = new JPanel(new BorderLayout(10, 10));
        contentPane.setBorder(BorderFactory.createEmptyBorder(12, 12, 12, 12));
        setContentPane(contentPane);

        JPanel filtrosPanel = new JPanel(new GridBagLayout());
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(4, 4, 4, 4);
        gbc.anchor = GridBagConstraints.WEST;

        JLabel lblMensajero = new JLabel("Mensajero:");
        gbc.gridx = 0;
        gbc.gridy = 0;
        filtrosPanel.add(lblMensajero, gbc);

        comboMensajero = new JComboBox<>();
        gbc.gridx = 1;
        gbc.gridy = 0;
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.weightx = 1.0;
        filtrosPanel.add(comboMensajero, gbc);

        JLabel lblBanco = new JLabel("Banco:");
        gbc.gridx = 0;
        gbc.gridy = 1;
        gbc.weightx = 0;
        gbc.fill = GridBagConstraints.NONE;
        filtrosPanel.add(lblBanco, gbc);

        comboBanco = new JComboBox<>();
        gbc.gridx = 1;
        gbc.gridy = 1;
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.weightx = 1.0;
        filtrosPanel.add(comboBanco, gbc);

        JButton btnAplicar = new JButton("Aplicar filtros");
        gbc.gridx = 0;
        gbc.gridy = 2;
        gbc.fill = GridBagConstraints.NONE;
        gbc.weightx = 0;
        filtrosPanel.add(btnAplicar, gbc);

        JButton btnLimpiar = new JButton("Limpiar filtros");
        gbc.gridx = 1;
        gbc.gridy = 2;
        gbc.anchor = GridBagConstraints.EAST;
        filtrosPanel.add(btnLimpiar, gbc);

        contentPane.add(filtrosPanel, BorderLayout.NORTH);

        modeloTabla = new DefaultTableModel(new Object[]{
                "Fecha", "Mensajero", "Cliente", "Banco", "Dirección", "Estado"
        }, 0) {
            private static final long serialVersionUID = 1L;

            @Override
            public boolean isCellEditable(int row, int column) {
                return false;
            }
        };
        tablaHistorial = new JTable(modeloTabla);
        tablaHistorial.setFillsViewportHeight(true);
        tablaHistorial.setAutoCreateRowSorter(true);

        JScrollPane scrollPane = new JScrollPane(tablaHistorial);
        contentPane.add(scrollPane, BorderLayout.CENTER);

        btnAplicar.addActionListener(e -> aplicarFiltros());
        btnLimpiar.addActionListener(e -> limpiarFiltros());

        cargarOpcionesFiltros();
        refrescarTabla(historialCompleto);
    }

    private void cargarOpcionesFiltros() {
        Set<String> mensajeros = new LinkedHashSet<>();
        Set<String> bancos = new LinkedHashSet<>();
        boolean existeMensajeroVacio = false;
        boolean existeBancoVacio = false;

        mensajeros.add("Todos");
        bancos.add("Todos");

        for (HistorialEntrega entrada : historialCompleto) {
            if (entrada == null) continue;
            String displayMensajero = displayOrDefault(entrada.getMensajeroDisplay(), "");
            if (!displayMensajero.isEmpty()) {
                mensajeros.add(displayMensajero);
            } else {
                existeMensajeroVacio = true;
            }
            String banco = displayOrDefault(entrada.getBanco(), "");
            if (!banco.isEmpty()) {
                bancos.add(banco);
            } else {
                existeBancoVacio = true;
            }
        }

        if (existeMensajeroVacio) {
            mensajeros.add("Sin mensajero");
        }
        if (existeBancoVacio) {
            bancos.add("Sin banco registrado");
        }

        comboMensajero.setModel(new DefaultComboBoxModel<>(mensajeros.toArray(new String[0])));
        comboBanco.setModel(new DefaultComboBoxModel<>(bancos.toArray(new String[0])));
    }

    private void aplicarFiltros() {
        String mensajeroSeleccionado = (String) comboMensajero.getSelectedItem();
        String bancoSeleccionado = (String) comboBanco.getSelectedItem();

        List<HistorialEntrega> filtrado = new ArrayList<>();
        for (HistorialEntrega entrada : historialCompleto) {
            if (entrada == null) continue;

            boolean coincideMensajero = mensajeroSeleccionado == null
                    || "Todos".equals(mensajeroSeleccionado)
                    || displayOrDefault(entrada.getMensajeroDisplay(), "Sin mensajero").equals(mensajeroSeleccionado);

            String bancoEntrada = displayOrDefault(entrada.getBanco(), "Sin banco registrado");
            boolean coincideBanco = bancoSeleccionado == null || "Todos".equals(bancoSeleccionado)
                    || bancoEntrada.equalsIgnoreCase(bancoSeleccionado);

            if (coincideMensajero && coincideBanco) {
                filtrado.add(entrada);
            }
        }

        refrescarTabla(filtrado);
    }

    private void limpiarFiltros() {
        comboMensajero.setSelectedIndex(0);
        comboBanco.setSelectedIndex(0);
        refrescarTabla(historialCompleto);
    }

    private void refrescarTabla(List<HistorialEntrega> entradas) {
        modeloTabla.setRowCount(0);
        for (HistorialEntrega entrada : entradas) {
            if (entrada == null) continue;

            String fecha = displayOrDefault(entrada.getFecha(), "Sin fecha");
            String mensajero = displayOrDefault(entrada.getMensajeroDisplay(), "Sin mensajero");
            String cliente = displayOrDefault(entrada.getCliente(), "Sin cliente registrado");
            String banco = displayOrDefault(entrada.getBanco(), "Sin banco registrado");
            String direccion = displayOrDefault(entrada.getDireccion(), "Sin dirección registrada");
            modeloTabla.addRow(new Object[]{
                    fecha,
                    mensajero,
                    cliente,
                    banco,
                    direccion,
                    entrada.isConforme() ? "Conforme" : "Observado"
            });
        }
    }

    private void recargarHistorial() {
        historialCompleto.clear();
        historialCompleto.addAll(controlador.obtenerHistorialEntregas());
    }

    private String displayOrDefault(String value, String defaultText) {
        if (value == null) {
            return defaultText;
        }
        String trimmed = value.trim();
        return trimmed.isEmpty() ? defaultText : trimmed;
    }
}