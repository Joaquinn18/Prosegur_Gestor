package GUI;
import javax.swing.*;
import java.awt.*;
import GUI.Entrega;
import Controlador.ControladorMotorizado;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;
import javax.swing.JFileChooser;
import repositorio.FileManager;
import repositorio.InMemoryDatabase;
import Modelado.HistorialEntrega;
import Modelado.Motorizado;
import Controlador.ControladorMotorizado;



public class MainMenu extends JFrame implements ActionListener {
	private static final long serialVersionUID = 1L;
	private JButton btnRegistroMotorizado;
    private ControladorMotorizado controlador;
    private JButton btnRegistrarEntregas;
    private JButton btnReporteEntregas;
    private JButton btnExportar;
    private JButton btnImportar;
    private JButton btnBackup;
    private JButton btnHistorialEntregas;
    
    public MainMenu() {
        controlador = new ControladorMotorizado();

        setTitle("Menú Principal - Sistema");
        setSize(415, 403);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setLocationRelativeTo(null);

        JPanel panel = new JPanel();
        panel.setLayout(null);

        btnRegistroMotorizado = new JButton("Registrar Motorizado");
        btnRegistroMotorizado.setBounds(85, 29, 201, 25);
        panel.add(btnRegistroMotorizado);

        getContentPane().add(panel);
        
        JButton btnListadoMotorizados = new JButton("Listado de Motorizados");
        btnListadoMotorizados.setBounds(85, 65, 201, 25);
        panel.add(btnListadoMotorizados);
        
        btnRegistrarEntregas = new JButton("Registrar Entregas");
        btnRegistrarEntregas.addActionListener(this);
        btnRegistrarEntregas.setBounds(87, 101, 199, 25);
        panel.add(btnRegistrarEntregas);

        btnReporteEntregas = new JButton("Reporte Entregas");
        btnReporteEntregas.setBounds(85, 137, 201, 25); // ajusta Y si tienes otros botones
        panel.add(btnReporteEntregas);

        btnExportar = new JButton("Exportar CSV");
        btnExportar.addActionListener(this);
        btnExportar.setBounds(122, 173, 143, 25);
        panel.add(btnExportar);

        btnImportar = new JButton("Importar CSV");
        btnImportar.addActionListener(this);
        btnImportar.setBounds(122, 210, 143, 25);
        panel.add(btnImportar);

        btnBackup = new JButton("Backup");
        btnBackup.addActionListener(this);
        btnBackup.setBounds(122, 246, 143, 25);
        panel.add(btnBackup);
        
        btnHistorialEntregas = new JButton("Historial Entregas");
        btnHistorialEntregas.addActionListener(this);
        btnHistorialEntregas.setBounds(87, 291, 201, 25);
        panel.add(btnHistorialEntregas);
        
        
        btnReporteEntregas.addActionListener(e -> {
            ReporteEntregasFrame reporte = new ReporteEntregasFrame(controlador != null ? controlador : new ControladorMotorizado());
            reporte.setVisible(true);
        });
        
        btnListadoMotorizados.addActionListener(e -> {
            ListadoMotorizadoFrame listadoFrame = new ListadoMotorizadoFrame(controlador);
            listadoFrame.setVisible(true);
        });
       
        btnRegistroMotorizado.addActionListener(e -> {
            RegistroMotorizadoFrame registroFrame = new RegistroMotorizadoFrame(controlador);
            registroFrame.setVisible(true);
        });
    }
    
    
	public void actionPerformed(ActionEvent e) {
		if (e.getSource() == btnHistorialEntregas) {
			do_btnHistorialEntregas_actionPerformed(e);
		}
		if (e.getSource() == btnBackup) {
			do_btnBackup_actionPerformed(e);
		}
		if (e.getSource() == btnImportar) {
			do_btnImportar_actionPerformed(e);
		}
		if (e.getSource() == btnExportar) {
			do_btnExportar_actionPerformed(e);
		}
		if (e.getSource() == btnRegistrarEntregas) {
			do_btnRegistrarEntregas_actionPerformed(e);
		}
	}
	protected void do_btnRegistrarEntregas_actionPerformed(ActionEvent e) {
		
	    String dniSeleccionado = JOptionPane.showInputDialog(this, "Ingrese DNI del motorizado para registrar entrega:");
	    if (dniSeleccionado == null) return; 
	    dniSeleccionado = dniSeleccionado.trim();

	    
	    if (!dniSeleccionado.matches("\\d{8}")) {
	        JOptionPane.showMessageDialog(this, "DNI inválido: debe contener exactamente 8 dígitos.");
	        return;
	    }

	   
	    ControladorMotorizado controladorActivo = this.controlador != null ? this.controlador : new ControladorMotorizado();

        if (!controladorActivo.existeDni(dniSeleccionado)) {
            JOptionPane.showMessageDialog(this,
                    "No existe motorizado con el DNI ingresado.",
                    "Motorizado no encontrado",
                    JOptionPane.WARNING_MESSAGE);
            return;
        }

        Entrega ef = new Entrega(controladorActivo, dniSeleccionado);
	    ef.setVisible(true);

	 
	    ef.addWindowListener(new java.awt.event.WindowAdapter() {
	        @Override
	        public void windowClosed(java.awt.event.WindowEvent e) {
	
	        }
	    });
		
		
	}
	
	
	protected void do_btnExportar_actionPerformed(ActionEvent e) {
		
		 try {
		        Path pMot = Paths.get("data", "motorizados.csv");
		        FileManager.exportarMotorizadosCSV(InMemoryDatabase.getMotorizados(), pMot);

		        Path pEnt = Paths.get("data", "entregas.csv");
		        FileManager.exportarEntregasCSV(InMemoryDatabase.getEntregas(), pEnt);

		        JOptionPane.showMessageDialog(this, "Exportado motorizados y entregas a carpeta data/");
		    } catch (Exception ex) {
		        ex.printStackTrace();
		        JOptionPane.showMessageDialog(this, "Error al exportar: " + ex.getMessage());
		    }
	}
	protected void do_btnImportar_actionPerformed(ActionEvent e) {
		 JFileChooser chooser = new JFileChooser("data");
		    chooser.setDialogTitle("Selecciona CSV de motorizados para importar");
		    int res = chooser.showOpenDialog(this);
		    if (res == JFileChooser.APPROVE_OPTION) {
		        try {
		            Path sel = chooser.getSelectedFile().toPath();
		            List<Motorizado> importados = FileManager.importarMotorizadosCSV(sel);
		            int agregados = 0;
		            int omitidos = 0;
		            for (Motorizado m : importados) {
		                if (!InMemoryDatabase.existeDni(m.getDni())) {
		                    InMemoryDatabase.addMotorizado(m);
		                    agregados++;
		                } else {
		                    omitidos++;
		                }
		            }
		            JOptionPane.showMessageDialog(this, "Importación finalizada. Agregados: " + agregados + " | Omitidos (duplicados): " + omitidos);
		        } catch (Exception ex) {
		            ex.printStackTrace();
		            JOptionPane.showMessageDialog(this, "Error al importar: " + ex.getMessage());
		        }
		    }
		
	}
	protected void do_btnBackup_actionPerformed(ActionEvent e) {
		  try {
		       
		        Path src = Paths.get("data", "motorizados.csv");
		        Path dest = Paths.get("data", "backup", "motorizados_backup_" + System.currentTimeMillis() + ".csv");
		        FileManager.backupFile(src, dest);
		        JOptionPane.showMessageDialog(this, "Backup creado: " + dest.toString());
		    } catch (Exception ex) {
		        ex.printStackTrace();
		        JOptionPane.showMessageDialog(this, "Error al crear backup: " + ex.getMessage());
		    }
	}
	protected void do_btnHistorialEntregas_actionPerformed(ActionEvent e) {
			
	}
    }
